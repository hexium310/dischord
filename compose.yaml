services:
  voicevox:
    image: voicevox/voicevox_engine:cpu-ubuntu20.04-latest

  web:
    build:
      context: .
      target: development
    tty: true
    volumes:
      - type: bind
        source: Cargo.lock
        target: /usr/src/myapp/Cargo.lock
      - type: bind
        source: Cargo.toml
        target: /usr/src/myapp/Cargo.toml
      - type: bind
        source: crates
        target: /usr/src/myapp/crates
      - type: bind
        source: seitai
        target: /usr/src/myapp/seitai
      - type: bind
        source: restarter
        target: /usr/src/myapp/restarter
      - type: bind
        source: epitran-kana
        target: /usr/src/myapp/epitran-kana
      - type: bind
        source: resources
        target: /usr/src/myapp/resources
        read_only: true
    command: /bin/sh -c 'cargo run -p seitai'
    environment:
      - DISCORD_TOKEN
      - VOICEVOX_HOST=voicevox
    depends_on:
      init_resource:
        condition: service_completed_successfully
  init_resource:
    image: curlimages/curl
    working_dir: /home/curl_user
    volumes:
      - type: bind
        source: init_resource.sh
        target: /home/curl_user/init_resource.sh
      - type: bind
        source: resources/
        target: /home/curl_user/resources/
    command:
      - sh
      - init_resource.sh
    environment:
      - VOICEVOX_HOST=voicevox
    depends_on:
      - voicevox
    restart: on-failure
  restarter:
    build:
      context: .
      target: development
    tty: true
    volumes:
      - type: bind
        source: Cargo.lock
        target: /usr/src/myapp/Cargo.lock
      - type: bind
        source: Cargo.toml
        target: /usr/src/myapp/Cargo.toml
      - type: bind
        source: crates
        target: /usr/src/myapp/crates
      - type: bind
        source: seitai
        target: /usr/src/myapp/seitai
      - type: bind
        source: restarter
        target: /usr/src/myapp/restarter
      - type: bind
        source: epitran-kana
        target: /usr/src/myapp/epitran-kana
    command: /bin/sh -c 'cargo run -p restarter'
    environment:
      - DISCORD_TOKEN
  epitran-kana:
    build:
      context: .
      target: development
    volumes:
      - type: bind
        source: Cargo.lock
        target: /usr/src/myapp/Cargo.lock
      - type: bind
        source: Cargo.toml
        target: /usr/src/myapp/Cargo.toml
      - type: bind
        source: crates
        target: /usr/src/myapp/crates
      - type: bind
        source: seitai
        target: /usr/src/myapp/seitai
      - type: bind
        source: restarter
        target: /usr/src/myapp/restarter
      - type: bind
        source: epitran-kana
        target: /usr/src/myapp/epitran-kana
    command: /bin/sh -c 'cargo run -p epitran-kana'
    # environment:
    #   - PYTHONPATH=/usr/local/lib/python3.11/site-packages
